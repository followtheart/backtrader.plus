# Backtrader C++ é¡¹ç›®æ¶æ„åˆ†æ

è¿™æ˜¯ä¸€ä¸ª **Python Backtrader é‡åŒ–å›æµ‹æ¡†æ¶çš„ C++ é«˜æ€§èƒ½é‡æ„ç‰ˆæœ¬**ï¼Œç›®å‰å¤„äº v0.4.0 ç‰ˆæœ¬ã€‚

---

## ğŸ—ï¸ æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Python å±‚                                â”‚
â”‚                    (pybind11 ç»‘å®š)                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                        æ ¸å¿ƒå¼•æ“å±‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ Cerebro â”‚â”€â”€â”‚ Strategy â”‚â”€â”€â”‚ Broker â”‚â”€â”€â”‚DataFeed â”‚            â”‚
â”‚  â”‚ (åè°ƒå™¨) â”‚  â”‚  (ç­–ç•¥)   â”‚  â”‚(ç»çºªå•†) â”‚  â”‚(æ•°æ®æº) â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜            â”‚
â”‚       â”‚            â”‚            â”‚            â”‚                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”            â”‚
â”‚  â”‚Analyzer â”‚  â”‚Indicatorâ”‚  â”‚ Order   â”‚  â”‚DateTime â”‚            â”‚
â”‚  â”‚Observer â”‚  â”‚ Signal  â”‚  â”‚ Trade   â”‚  â”‚TimeFrameâ”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                        åŸºç¡€è®¾æ–½å±‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚ LineBuffer â”‚  â”‚ LineSeries â”‚  â”‚  Params  â”‚                  â”‚
â”‚  â”‚ (æ—¶åºç¼“å†²) â”‚  â”‚ (å¤šçº¿å®¹å™¨) â”‚  â”‚ (å‚æ•°ç³»ç»Ÿ)â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                        æ€§èƒ½ä¼˜åŒ–å±‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚   SIMD   â”‚  â”‚ ThreadPool â”‚  â”‚ Optimizer â”‚                   â”‚
â”‚  â”‚ å‘é‡åŒ–è®¡ç®— â”‚  â”‚  å¤šçº¿ç¨‹æ±    â”‚  â”‚ å‚æ•°ä¼˜åŒ–  â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¦ æ ¸å¿ƒç»„ä»¶åˆ†æ

### 1. åŸºç¡€è®¾æ–½å±‚ (`core/`)

| ç»„ä»¶ | æ–‡ä»¶ | æè¿° |
|------|------|------|
| `LineBuffer` | `include/bt/linebuffer.hpp` | æ ¸å¿ƒæ—¶åºæ•°æ®ç»“æ„ï¼Œæ”¯æŒ `[0]` å½“å‰å€¼ã€`[1]` å†å²å€¼ç´¢å¼• |
| `LineSeries` | `include/bt/lineseries.hpp` | å¤šçº¿å®¹å™¨ï¼Œç®¡ç†å¤šæ¡ LineBuffer |
| `Params` | `include/bt/params.hpp` | å‚æ•°ç³»ç»Ÿï¼Œä½¿ç”¨ `std::variant` å­˜å‚¨å¤šç±»å‹å‚æ•° |

**LineBuffer ç‰¹æ€§ï¼š**
- æ”¯æŒä¸¤ç§å­˜å‚¨ç­–ç•¥ï¼š`UnboundedStorage`ï¼ˆä¿å­˜å…¨éƒ¨å†å²ï¼‰å’Œ `QBufferStorage`ï¼ˆå›ºå®šå¤§å°ç¯å½¢ç¼“å†²ï¼‰
- Python é£æ ¼çš„è´Ÿç´¢å¼•è®¿é—®ï¼ˆ`[-1]` è®¿é—®æœªæ¥å€¼ï¼Œç”¨äºæŒ‡æ ‡é¢„è®¡ç®—ï¼‰

### 2. æ ¸å¿ƒå¼•æ“å±‚

| ç»„ä»¶ | æ–‡ä»¶ | èŒè´£ |
|------|------|------|
| `Cerebro` | `include/bt/cerebro.hpp` | **ä¸»åè°ƒå¼•æ“**ï¼šç®¡ç†æ•°æ®ã€ç­–ç•¥ã€åˆ†æå™¨ã€è§‚å¯Ÿå™¨ |
| `Strategy` | `include/bt/strategy.hpp` | ç­–ç•¥åŸºç±»ï¼Œæä¾›å®Œæ•´ç”Ÿå‘½å‘¨æœŸï¼ˆinit/start/next/stopï¼‰ |
| `Broker` | `include/bt/broker.hpp` | ç»çºªå•†æ¨¡æ‹Ÿï¼Œæ”¯æŒæ»‘ç‚¹ã€ä½£é‡‘ã€Cheat-on-Open/Close |
| `DataFeed` | `include/bt/datafeed.hpp` | æ•°æ®æºæŠ½è±¡ï¼Œæ”¯æŒ CSV/å†…å­˜æ•°æ® |
| `Order/Trade` | `include/bt/order.hpp` | è®¢å•ç³»ç»Ÿï¼Œæ”¯æŒ Market/Limit/Stop/Bracket/OCO ç­‰ |

**ç­–ç•¥ç”Ÿå‘½å‘¨æœŸï¼š**
```
init() â†’ start() â†’ [prenext()...] â†’ nextstart() â†’ [next()...] â†’ stop()
```

### 3. æŒ‡æ ‡ç³»ç»Ÿ (`indicators/`)

| æŒ‡æ ‡ | æ–‡ä»¶ |
|------|------|
| SMA | `include/bt/indicators/sma.hpp` |
| EMA | `include/bt/indicators/ema.hpp` |
| MACD | `include/bt/indicators/macd.hpp` |
| RSI | `include/bt/indicators/rsi.hpp` |
| Bollinger Bands | `include/bt/indicators/bollinger.hpp` |

**æŒ‡æ ‡ç‰¹æ€§ï¼š**
- ç»§æ‰¿è‡ª `LineSeries`ï¼Œæ”¯æŒé“¾å¼è®¡ç®—
- æ”¯æŒå‘é‡åŒ–æ‰¹é‡è®¡ç®— (`once()`) å’Œé€ bar è®¡ç®— (`next()`)
- è¿ç®—ç¬¦é‡è½½ï¼Œæ”¯æŒæŒ‡æ ‡é—´ç®—æœ¯è¿ç®—

### 4. æ€§èƒ½ä¼˜åŒ–å±‚

| æ¨¡å— | æ–‡ä»¶ | åŠŸèƒ½ |
|------|------|------|
| SIMD | `include/bt/simd.hpp` | SSE2/AVX/AVX2/AVX-512 å‘é‡åŒ–è¿ç®— |
| ThreadPool | `include/bt/threadpool.hpp` | çº¿ç¨‹æ± ï¼Œæ”¯æŒå¹¶è¡Œä»»åŠ¡è°ƒåº¦ |
| Optimizer | `include/bt/optimizer.hpp` | ç­–ç•¥å‚æ•°ç½‘æ ¼æœç´¢ä¼˜åŒ– |

**SIMD æ”¯æŒï¼š**
```cpp
// è‡ªåŠ¨æ£€æµ‹æŒ‡ä»¤é›†
simd::getSIMDLevel();  // "AVX2", "SSE2", "Scalar" ç­‰
simd::slidingMean();   // SIMD åŠ é€Ÿçš„æ»‘åŠ¨å¹³å‡
simd::rsi();           // SIMD åŠ é€Ÿçš„ RSI è®¡ç®—
```

### 5. é«˜çº§ç‰¹æ€§

| ç‰¹æ€§ | æ–‡ä»¶ | æè¿° |
|------|------|------|
| å¤šæ—¶é—´å‘¨æœŸ | `include/bt/timeframe.hpp`, `include/bt/resampler.hpp` | æ•°æ®é‡é‡‡æ · |
| ä¿¡å·ç³»ç»Ÿ | `include/bt/signal.hpp`, `include/bt/signalstrategy.hpp` | 14ç§ä¿¡å·ç±»å‹ |
| åˆ†æå™¨ | `include/bt/analyzer.hpp` | SharpeRatio, DrawDown, SQN ç­‰ |
| è§‚å¯Ÿå™¨ | `include/bt/observer.hpp` | Cash, Value, BuySell è§‚å¯Ÿ |

---

## ğŸ”§ æ„å»ºç³»ç»Ÿ

**CMake æ„å»ºé…ç½®ï¼š**
```cmake
option(BT_BUILD_TESTS "Build unit tests" ON)
option(BT_BUILD_PYTHON "Build Python bindings" ON)
option(BT_BUILD_EXAMPLES "Build examples" ON)
option(BT_ENABLE_SIMD "Enable SIMD optimizations" ON)
```

**ç›®å½•ç»“æ„ï¼š**
```
â”œâ”€â”€ include/bt/          # å¤´æ–‡ä»¶ï¼ˆheader-only è®¾è®¡ä¸ºä¸»ï¼‰
â”œâ”€â”€ src/                 # æ ¸å¿ƒå®ç°
â”‚   â”œâ”€â”€ core/           # åŸºç¡€è®¾æ–½å®ç°
â”‚   â””â”€â”€ indicators/     # æŒ‡æ ‡å®ç°
â”œâ”€â”€ python/             # pybind11 Python ç»‘å®š
â”œâ”€â”€ tests/              # Google Test å•å…ƒæµ‹è¯•
â””â”€â”€ examples/           # ç¤ºä¾‹ç¨‹åº
```

---

## ğŸ Python ç»‘å®š

é€šè¿‡ **pybind11** æš´éœ² C++ API åˆ° Pythonï¼š

```python
import _backtrader_cpp as bt
bt.version()  # "0.4.0"

# LineBuffer
buf = bt.LineBuffer()
buf.push(100.0)
print(buf[0])  # å½“å‰å€¼
```

---

## ğŸ“Š æ•°æ®æµæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DataFeed â”‚â”€â”€â”€â–¶â”‚ Cerebro  â”‚â”€â”€â”€â–¶â”‚ Strategy â”‚â”€â”€â”€â–¶â”‚  Broker   â”‚
â”‚  (OHLCV) â”‚    â”‚ (Engine) â”‚    â”‚ (Logic)  â”‚    â”‚ (Orders)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                     â”‚               â”‚                â”‚
                     â–¼               â–¼                â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ Analyzer â”‚    â”‚Indicator â”‚    â”‚Position/  â”‚
              â”‚ Observer â”‚    â”‚ Signal   â”‚    â”‚ Trade     â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ è®¾è®¡äº®ç‚¹

1. **Python å…¼å®¹ API**ï¼šä¿æŒä¸ Python Backtrader ç›¸ä¼¼çš„æ¥å£è®¾è®¡
2. **é«˜æ€§èƒ½**ï¼šSIMD å‘é‡åŒ– + å¤šçº¿ç¨‹å¹¶è¡Œä¼˜åŒ–
3. **å†…å­˜æ•ˆç‡**ï¼šæ”¯æŒ QBuffer å›ºå®šå¤§å°ç¼“å†²ï¼ŒèŠ‚çœå†…å­˜
4. **æ¨¡å—åŒ–**ï¼šæ¸…æ™°çš„ç»„ä»¶åˆ†ç¦»ï¼Œæ˜“äºæ‰©å±•
5. **ç±»å‹å®‰å…¨**ï¼šC++17 ç‰¹æ€§ï¼Œä½¿ç”¨ `std::variant`ã€`std::optional` ç­‰

---

## ğŸ“ˆ é¡¹ç›®è¿›åº¦

| é˜¶æ®µ | çŠ¶æ€ | å†…å®¹ |
|------|------|------|
| Phase 1 | âœ… å®Œæˆ | åŸºç¡€è®¾æ–½ï¼ˆLineBuffer, Params, åŸºç¡€æŒ‡æ ‡ï¼‰ |
| Phase 2 | âœ… å®Œæˆ | æ ¸å¿ƒå¼•æ“ï¼ˆCerebro, Strategy, Broker, Orderï¼‰ |
| Phase 3 | âœ… å®Œæˆ | é«˜çº§ç‰¹æ€§ï¼ˆå¤šæ—¶é—´å‘¨æœŸ, ä¿¡å·ç³»ç»Ÿ, Bracketè®¢å•ï¼‰ |
| Phase 4 | âœ… å®Œæˆ | æ€§èƒ½ä¼˜åŒ–ï¼ˆSIMD, å¤šçº¿ç¨‹, ç­–ç•¥ä¼˜åŒ–å™¨ï¼‰ |

---

## ğŸ“ å…³é”®æ–‡ä»¶ç´¢å¼•

### å…¥å£æ–‡ä»¶
- `include/bt/backtrader.hpp` - ä¸»å¤´æ–‡ä»¶ï¼ŒåŒ…å«æ‰€æœ‰æ¨¡å—

### æ ¸å¿ƒç±»
- `include/bt/cerebro.hpp` - Cerebro å›æµ‹å¼•æ“
- `include/bt/strategy.hpp` - Strategy ç­–ç•¥åŸºç±»
- `include/bt/broker.hpp` - Broker ç»çºªå•†
- `include/bt/datafeed.hpp` - DataFeed æ•°æ®æº
- `include/bt/order.hpp` - Order/Trade è®¢å•ç³»ç»Ÿ

### åŸºç¡€è®¾æ–½
- `include/bt/linebuffer.hpp` - LineBuffer æ—¶åºç¼“å†²
- `include/bt/lineseries.hpp` - LineSeries å¤šçº¿å®¹å™¨
- `include/bt/params.hpp` - Params å‚æ•°ç³»ç»Ÿ
- `include/bt/indicator.hpp` - Indicator æŒ‡æ ‡åŸºç±»

### æ€§èƒ½ä¼˜åŒ–
- `include/bt/simd.hpp` - SIMD å‘é‡åŒ–è¿ç®—
- `include/bt/threadpool.hpp` - çº¿ç¨‹æ± 
- `include/bt/optimizer.hpp` - å‚æ•°ä¼˜åŒ–å™¨
- `include/bt/vectorized.hpp` - å‘é‡åŒ–æ¥å£

### é«˜çº§ç‰¹æ€§
- `include/bt/signal.hpp` - ä¿¡å·ç³»ç»Ÿ
- `include/bt/signalstrategy.hpp` - ä¿¡å·ç­–ç•¥
- `include/bt/resampler.hpp` - æ•°æ®é‡é‡‡æ ·
- `include/bt/timeframe.hpp` - æ—¶é—´å‘¨æœŸ
- `include/bt/analyzer.hpp` - åˆ†æå™¨
- `include/bt/observer.hpp` - è§‚å¯Ÿå™¨
